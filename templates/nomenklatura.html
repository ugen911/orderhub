{% extends "base.html" %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<style>
    .state-button {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        color: white;
        margin: 4px 6px 4px 0;
    }

    .state-true {
        background-color: #dc3545;
    }

    .state-false {
        background-color: #6c757d;
    }

    .minibox {
        background-color: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        height: 100%;
    }

    .section-title {
        margin-top: 2rem;
        font-weight: bold;
    }
</style>

<div class="container-fluid p-3">
    <form action="/nomenklatura/search" method="get" class="row g-2 align-items-center mb-3">
        <div class="col-auto">
            <input type="text" name="kod" class="form-control form-control-sm" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É">
        </div>
        <div class="col-auto">
            <input type="text" name="artikul" class="form-control form-control-sm" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É">
        </div>
        <div class="col-auto">
            <button class="btn btn-sm btn-primary"><i class="bi bi-search"></i> –ù–∞–π—Ç–∏</button>
        </div>
        <div class="col-auto">
            <a href="/nomenklatura/{{ data.kod }}/prev" class="btn btn-sm btn-outline-secondary"><i
                    class="bi bi-arrow-left"></i></a>
            <a href="/nomenklatura/{{ data.kod }}/next" class="btn btn-sm btn-outline-secondary"><i
                    class="bi bi-arrow-right"></i></a>
            <a href="/nomenklatura/{{ data.kod }}/view" class="btn btn-sm btn-outline-success"><i
                    class="bi bi-arrow-clockwise"></i></a>
        </div>
    </form>

    <div class="mb-3 d-flex flex-wrap">
        {% for flag, label in [
        ('ne_ispolzuetsya_v_zakaze', '–ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø –í –ó–ê–ö–ê–ó–ï'),
        ('nelikvid', '–ù–ï–õ–ò–ö–í–ò–î'),
        ('list_ozhidaniya', '–û–ñ–ò–î–ê–ù–ò–ï'),
        ('zafiksirovat_minimalki', '–ó–ê–§–ò–ö–°–ò–†–û–í–ê–¢–¨'),
        ('pometkaudalenija', '–£–î–ê–õ–ï–ù')
        ] %}
        {% if flag != 'pometkaudalenija' %}
        <form method="post" action="/nomenklatura/{{ data.kod }}/toggle/{{ flag }}">
            <button class="state-button {{ 'state-true' if data[flag] else 'state-false' }}" type="submit">{{ label
                }}</button>
        </form>
        {% else %}
        <div class="state-button {{ 'state-true' if data[flag] else 'state-false' }}">{{ label }}</div>
        {% endif %}
        {% endfor %}
    </div>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
        <div class="col">
            <div class="minibox">
                <h6><i class="bi bi-upc"></i> –ö–æ–¥: {{ data.kod }}</h6>
                <p><strong>–ê—Ä—Ç–∏–∫—É–ª:</strong> {{ data.artikul }}</p>
                <p><strong>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å:</strong> {{ data.proizvoditel }}</p>
                <p><strong>–¢–∏–ø –¥–µ—Ç–∞–ª–∏:</strong> {{ data.type_detail }}</p>
                <p><strong>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</strong> {{ data.naimenovanie }}</p>
            </div>
        </div>

        <div class="col">
            <div class="minibox">
                <h6><i class="bi bi-currency-ruble"></i> –¶–µ–Ω—ã</h6>
                <p>–†–æ–∑–Ω–∏—á–Ω–∞—è: <strong>{{ data.tsenarozn|float|round|int }}‚ÇΩ</strong></p>
                <p>–ó–∞–∫—É–ø: {{ data.tsenazakup|float|round|int }}‚ÇΩ</p>
                <p>–°—Ä–µ–¥–Ω—è—è: {{ data.middleprice|float|round|int }}‚ÇΩ</p>
                <p>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è: {{ data.maxprice|float|round|int }}‚ÇΩ</p>
            </div>
        </div>

        <div class="col">
            <div class="minibox">
                <h6><i class="bi bi-box"></i> –û—Å—Ç–∞—Ç–∫–∏</h6>
                <p>–û—Å–Ω–æ–≤–Ω–æ–π —Å–∫–ª–∞–¥: {{ data.osnsklad|float|round|int }} {{ data.edizm }}</p>
                <p>–°–∫–ª–∞–¥ –∑–∞–∫–∞–∑–æ–≤: {{ data.zakazy_sklad|float|round|int }}</p>
                <p>–°—Ç–µ–ª–ª–∞–∂: {{ data.stellazh }}</p>
            </div>
        </div>

        <div class="col">
            <div class="minibox">
                <h6><i class="bi bi-truck"></i> –ü–æ—Å—Ç–∞–≤—â–∏–∫</h6>
                <p>–°–∫–ª–∞–¥: {{ data.delivery_sklad }}</p>
                <p>–û—Å—Ç–∞—Ç–æ–∫: {{ data.delivery_stock|float|round|int }}</p>
                <p>–¶–µ–Ω–∞: {{ data.delivery_price|float|round|int }}‚ÇΩ</p>
            </div>
        </div>

        <div class="col">
            <div class="minibox">
                <h6><i class="bi bi-arrow-down-up"></i> –ú–∏–Ω–∏–º—É–º</h6>
                <label for="minimal">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫:</label>
                <input type="number" step="1" name="minimal" id="minimal"
                    class="form-control form-control-sm autosave-field" data-kod="{{ data.kod }}"
                    value="{{ data.minimal|float|round|int }}">
                <p class="mt-2">–†–∞—Å—á–µ—Ç–Ω—ã–π: {{ data.minimal_raschet|float|round|int }}</p>
            </div>
        </div>

        <div class="col">
            <div class="minibox">
                <h6><i class="bi bi-graph-up"></i> ABC / XYZ</h6>
                <p>ABC: {{ data.abc }}</p>
                <p>XYZ: {{ data.xyz }}</p>
                <p>–ü—Ä–æ–¥–∞–Ω–æ –∑–∞ –≥–æ–¥: {{ data.total_sales_last_12_months|float|round|int }}</p>
                <p>–ü—Ä–æ–¥–∞–Ω–æ –∑–∞ 3 –º–µ—Å: {{ data.total_sales_last_3_months|float|round|int }}</p>
            </div>
        </div>
    </div>

    <h5 class="section-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º</h5>
    {% include "blocks/statistics.html" %}

    <h5 class="section-title">üîÅ –ê–Ω–∞–ª–æ–≥–∏</h5>
    {% include "blocks/analogs.html" %}

    <h5 class="section-title">üßæ –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h5>
    <div style="max-height: 400px; overflow-y: auto;">
        {% include "blocks/orders.html" %}
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const fields = document.querySelectorAll(".autosave-field");
        fields.forEach(field => {
            field.addEventListener("blur", () => {
                const kod = field.dataset.kod;
                const name = field.name;
                const value = field.value;
                fetch(`/nomenklatura/${kod}/update_field`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                    },
                    body: `field=${encodeURIComponent(name)}&value=${encodeURIComponent(value)}`
                });
            });
        });
    });
</script>
{% endblock %}