{% extends "base.html" %}
{% block content %}
<style>
    .state-button {
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        color: white;
        margin: 4px 6px 4px 0;
        white-space: nowrap;
    }

    .state-true {
        background-color: #dc3545;
    }

    .state-false {
        background-color: #6c757d;
    }

    .highlight-price {
        font-size: 1.2rem;
        font-weight: bold;
        color: #2c3e50;
    }

    .minibox {
        background-color: #f8f9fa;
        padding: 10px 14px;
        border-radius: 6px;
        margin-bottom: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .section-title {
        margin-top: 2rem;
        margin-bottom: 1rem;
        font-weight: bold;
    }

    .search-controls {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .search-controls input {
        width: 180px;
    }
</style>

<div class="container-fluid p-3 p-md-4">

    <!-- üîç –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="search-controls mb-3">
        <form action="/nomenklatura/search" method="get" class="d-flex flex-wrap gap-2">
            <input type="text" name="kod" class="form-control form-control-sm" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É">
            <input type="text" name="artikul" class="form-control form-control-sm" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É">
            <button type="submit" class="btn btn-sm btn-primary">–ù–∞–π—Ç–∏</button>
            <a href="/nomenklatura/{{ data.kod }}/prev" class="btn btn-sm btn-outline-secondary">‚Üê –ù–∞–∑–∞–¥</a>
            <a href="/nomenklatura/{{ data.kod }}/next" class="btn btn-sm btn-outline-secondary">–í–ø–µ—Ä–µ–¥ ‚Üí</a>
            <a href="/nomenklatura/{{ data.kod }}/view" class="btn btn-sm btn-outline-success">–û–±–Ω–æ–≤–∏—Ç—å üîÑ</a>
        </form>
    </div>

    <!-- üîò –°–æ—Å—Ç–æ—è–Ω–∏—è -->
    <div class="mb-3 d-flex flex-wrap">
        {% for flag, label in [
        ('ne_ispolzuetsya_v_zakaze', '–ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø –í –ó–ê–ö–ê–ó–ï'),
        ('nelikvid', '–ù–ï–õ–ò–ö–í–ò–î'),
        ('list_ozhidaniya', '–û–ñ–ò–î–ê–ù–ò–ï'),
        ('zafiksirovat_minimalki', '–ó–ê–§–ò–ö–°–ò–†–û–í–ê–¢–¨'),
        ('pometkaudalenija', '–£–î–ê–õ–ï–ù')
        ] %}
        {% if flag != 'pometkaudalenija' %}
        <form method="post" action="/nomenklatura/{{ data.kod }}/toggle/{{ flag }}">
            <button class="state-button {{ 'state-true' if data[flag] else 'state-false' }}" type="submit">{{ label
                }}</button>
        </form>
        {% else %}
        <div class="state-button {{ 'state-true' if data[flag] else 'state-false' }}">{{ label }}</div>
        {% endif %}
        {% endfor %}
    </div>

    <!-- üìå –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ -->
    <div class="row g-3">
        <div class="col-12 col-lg-4">
            <div class="minibox">
                <h5><strong>–ö–æ–¥:</strong> {{ data.kod }}</h5>
                <p><strong>–ê—Ä—Ç–∏–∫—É–ª:</strong> {{ data.artikul }}</p>
                <p><strong>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å:</strong> {{ data.proizvoditel }}</p>
                <p><strong>–¢–∏–ø –¥–µ—Ç–∞–ª–∏:</strong> {{ data.type_detail }}</p>
                <p><strong>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</strong><br>{{ data.naimenovanie }}</p>
            </div>
        </div>

        <div class="col-12 col-lg-4">
            <div class="minibox">
                <p class="highlight-price">–†–æ–∑–Ω–∏—á–Ω–∞—è —Ü–µ–Ω–∞: {{ data.tsenarozn|float|round|int }}‚ÇΩ</p>
                <p>–ó–∞–∫—É–ø: {{ data.tsenazakup|float|round|int }}‚ÇΩ</p>
                <p>–°—Ä–µ–¥–Ω—è—è: {{ data.middleprice|float|round|int }}‚ÇΩ</p>
                <p>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è: {{ data.maxprice|float|round|int }}‚ÇΩ</p>
            </div>
            <div class="minibox">
                <p>–û—Å–Ω–æ–≤–Ω–æ–π —Å–∫–ª–∞–¥: {{ data.osnsklad|float|round|int }} {{ data.edizm }}</p>
                <p>–°–∫–ª–∞–¥ –∑–∞–∫–∞–∑–æ–≤: {{ data.zakazy_sklad|float|round|int }}</p>
                <p>–°—Ç–µ–ª–ª–∞–∂: {{ data.stellazh }}</p>
            </div>
        </div>

        <div class="col-12 col-lg-4">
            <div class="minibox">
                <p><strong>–°–∫–ª–∞–¥ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞:</strong> {{ data.delivery_sklad }}</p>
                <p>–û—Å—Ç–∞—Ç–æ–∫: {{ data.delivery_stock|float|round|int }}</p>
                <p>–¶–µ–Ω–∞: {{ data.delivery_price|float|round|int }}‚ÇΩ</p>
            </div>
            <div class="minibox">
                <label for="minimal"><strong>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫:</strong></label>
                <input type="number" step="1" name="minimal" id="minimal"
                    class="form-control form-control-sm autosave-field" data-kod="{{ data.kod }}"
                    value="{{ data.minimal|float|round|int }}">
                <p class="mt-2 mb-0">–†–∞—Å—á–µ—Ç–Ω—ã–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫: {{ data.minimal_raschet|float|round|int }}</p>
            </div>
            <div class="minibox">
                <p><strong>ABC:</strong> {{ data.abc }}</p>
                <p><strong>XYZ:</strong> {{ data.xyz }}</p>
                <p>–ü—Ä–æ–¥–∞–Ω–æ –∑–∞ –≥–æ–¥: {{ data.total_sales_last_12_months|float|round|int }}</p>
                <p>–ü—Ä–æ–¥–∞–Ω–æ –∑–∞ 3 –º–µ—Å: {{ data.total_sales_last_3_months|float|round|int }}</p>
            </div>
        </div>
    </div>

    <h5 class="section-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º</h5>
    {% include "blocks/statistics.html" %}

    <h5 class="section-title">–ê–Ω–∞–ª–æ–≥–∏</h5>
    {% include "blocks/analogs.html" %}

    <h5 class="section-title">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h5>
    <div style="max-height: 400px; overflow-y: auto;">
        {% include "blocks/orders.html" %}
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const fields = document.querySelectorAll(".autosave-field");
        fields.forEach(field => {
            field.addEventListener("blur", () => {
                const kod = field.dataset.kod;
                const name = field.name;
                const value = field.value;

                fetch(`/nomenklatura/${kod}/update_field`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                    },
                    body: `field=${encodeURIComponent(name)}&value=${encodeURIComponent(value)}`
                }).then(res => res.json()).then(data => {
                    if (data.error) {
                        console.warn("–û—à–∏–±–∫–∞:", data.error);
                    } else {
                        console.log(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${data.field} = ${data.value}`);
                    }
                });
            });
        });
    });
</script>
{% endblock %}